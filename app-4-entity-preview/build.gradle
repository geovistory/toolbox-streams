import java.util.regex.Pattern

/* 1
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'org.geovistory.toolbox.streams.java-application-conventions'

    // used to set semantic version
    id 'com.glovoapp.semantic-versioning' version '1.1.10'

    // Used to containerize apps
    id 'com.google.cloud.tools.jib' version '3.3.0'

    id 'io.quarkus'
}


dependencies {
    // for .env
    implementation 'io.github.cdimascio:dotenv-java:2.2.4'
}

application {
    // Define the main class for the application.
    mainClassName = 'org.geovistory.toolbox.streams.entity.preview.App'
}


jar {
    manifest.attributes('Main-Class': application.mainClassName)
}

/**
 * Get docker image tag
 * @return for example "ghcr.io/geovistory/toolbox-streams-entity-preview:0.1.0"
 */
String getDockerImageTag() {
    return 'ghcr.io/geovistory/toolbox-streams-entity-preview' + ':' + getDockerTagSuffix()
}

/**
 * Get docker tag suffix from semantic version and pull request metadata.
 * @return for example "0.2.3" or "0.1.0-pr-12.0"
 */
String getDockerTagSuffix() {
    if (pullRequestNumber) return "${project.semanticVersion.version.get()}-pr-${pullRequestNumber}.${pullRequestPushCount}"
    else return "${project.semanticVersion.version.get()}"
}


task("printDockerImageTag") {
    doLast {
        println getDockerImageTag()
    }
}

task("printDockerTagSuffix") {
    doLast {
        println getDockerTagSuffix()
    }
}


// inspired by https://discuss.gradle.org/t/how-to-get-gradle-variables-in-my-java-method/37580/2
task generateJava {
    ext.outputDir = "$buildDir/generated/java"
    outputs.dir outputDir
    doLast {
        mkdir "$outputDir/org/geovistory/toolbox/streams/entity/preview"
        file("$outputDir/org/geovistory/toolbox/streams/entity/preview/BuildProperties.java").text =
                """|package org.geovistory.toolbox.streams.entity.preview;
               |public class BuildProperties {
               |    public static String getDockerTagSuffix() { return "${getDockerTagSuffix()}"; }
               |    public static String getDockerImageTag() { return "${getDockerImageTag()}"; }
               |}""".stripMargin()
    }
}


task generateReflectionConfiguration {
    ext.outputDir = "$buildDir/generated/java"
    outputs.dir outputDir
    doFirst {
        var basePathSrc = project.projectDir.toString() + "/src/main/java/org/geovistory/toolbox/streams/entity/preview"
        var path = basePathSrc + "/AvroSerdes.java"
        var p = Pattern.compile("public Serde<(.*)>", Pattern.DOTALL)
        var classNames = new ArrayList<String>()


        classNames.add("io.debezium.data.geometry.Geography.class")
        classNames.add("Entity.class")
        classNames.add("Language.class")
        classNames.add("Appellation.class")
        classNames.add("LangString.class")
        classNames.add("Place.class")
        classNames.add("TimePrimitive.class")
        classNames.add("Dimension.class")
        classNames.add("Cell.class")
        classNames.add("Digital.class")
        classNames.add("NodeKey.class")
        classNames.add("NodeValue.class")

        var basePathBuild = "$outputDir"
        try {
            var myObj = new File(path)
            Scanner myReader = new Scanner(myObj)
            while (myReader.hasNextLine()) {
                String line = myReader.nextLine()
                var x = (line =~ p)
                if (x.size() > 0) {
                    var fullClassName = (line =~ p)[0][1].toString()
                    classNames.add(fullClassName + ".class")
                    if (fullClassName.startsWith("dev.")) {
                        var newFullName = fullClassName.replace("dev.", "stag.")
                        var parts = fullClassName.split("\\.")
                        var className = parts[parts.size() - 1]
                        var newPackageName = newFullName.replace("." + className, "")
                        var filePath = basePathBuild + "/" + newPackageName.replace(".", "/")
                        mkdir filePath
                        var file = filePath + "/" + className + ".java"
                        createExtendingAvroClass(file, newPackageName, className, fullClassName)
                        classNames.add(newFullName + ".class")

                        newFullName = fullClassName.replace("dev.", "prod.")
                        parts = fullClassName.split("\\.")
                        className = parts[parts.size() - 1]
                        newPackageName = newFullName.replace("." + className, "")
                        filePath = basePathBuild + "/" + newPackageName.replace(".", "/")
                        mkdir filePath
                        file = filePath + "/" + className + ".java"
                        createExtendingAvroClass(file, newPackageName, className, fullClassName)
                        classNames.add(newFullName + ".class")
                    }
                }
            }
            myReader.close()
        } catch (FileNotFoundException e) {
            System.out.println("An error occurred.")
            e.printStackTrace()
        }

        mkdir "$outputDir/org/geovistory/toolbox/streams/entity/preview"
        file("$outputDir/org/geovistory/toolbox/streams/entity/preview/ReflectionConfig.java").text =
                """|package org.geovistory.toolbox.streams.entity.preview;
                |
                |import io.quarkus.runtime.annotations.RegisterForReflection;
                |import org.geovistory.toolbox.streams.avro.*;
                |
                |@RegisterForReflection(targets = {
                |   """.stripMargin() +
                        classNames.toArray().toUnique().join(",\n|   ").stripMargin() +
                        """|})
                |public class ReflectionConfig {
                |}""".stripMargin()
    }
}
compileJava {
    dependsOn(generateReflectionConfiguration)
    dependsOn(generateJava)
}
sourceSets.main.java.srcDir generateReflectionConfiguration.outputDir
sourceSets.main.java.srcDir generateJava.outputDir


private static void createExtendingAvroClass(String filePath, String newPackageName, String className, String oldFullName) {

    var myFile = new File(filePath)
    myFile.createNewFile()
    var newText = "package " + newPackageName + ";\n" +
            "import io.quarkus.runtime.annotations.RegisterForReflection;\n" +
            "@RegisterForReflection\n" +
            "public class " + className + " extends " + oldFullName +
            " implements org.apache.avro.specific.SpecificRecord { }"
    myFile.write(newText)
}