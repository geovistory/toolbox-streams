name: Test and Dockerize

on:
  pull_request:
    branches: [ "main" ]

jobs:

  # JOB to run change detection
  detect-changes:
    runs-on: ubuntu-latest
    # Required permissions
    permissions:
      pull-requests: read
    # Set job outputs to values from filter step
    outputs:
      app-0-base-model: ${{ steps.filter.outputs.app-0-base-model }}
      app-0-field-changes: ${{ steps.filter.outputs.app-0-field-changes }}
      app-0-nodes: ${{ steps.filter.outputs.app-0-nodes }}
      app-0-statement-object: ${{ steps.filter.outputs.app-0-statement-object }}
      app-0-statement-subject: ${{ steps.filter.outputs.app-0-statement-subject }}
      app-1-base-config: ${{ steps.filter.outputs.app-1-base-config }}
      app-2-entity-label: ${{ steps.filter.outputs.app-2-entity-label }}
      app-3-analysis-statements: ${{ steps.filter.outputs.app-3-analysis-statements }}
      app-3-entity: ${{ steps.filter.outputs.app-3-entity }}
      app-3-fulltext: ${{ steps.filter.outputs.app-3-fulltext }}
      app-4-entity-preview: ${{ steps.filter.outputs.app-4-entity-preview }}
      app-5-rdf-serializer: ${{ steps.filter.outputs.app-5-rdf-serializer }}
    steps:
      # For pull requests it's not necessary to check out the code
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            app-0-base-model:
              - 'app-0-base-model/**'
            app-0-field-changes:
              - 'app-0-field-changes/**'
            app-0-nodes:
              - 'app-0-nodes/**'
            app-0-statement-subject:
              - 'app-0-statement-subject/**'
            app-0-statement-object:
              - 'app-0-statement-object/**'
            app-1-base-config:
              - 'app-1-base-config/**'
            app-2-entity-label:
              - 'app-2-entity-label/**'
            app-3-analysis-statements:
              - 'app-3-analysis-statements/**'
            app-3-entity:
              - 'app-3-entity/**'
            app-3-fulltext:
              - 'app-3-fulltext/**'
            app-4-entity-preview:
              - 'app-4-entity-preview/**'
            app-5-rdf-serializer:
              - 'app-5-rdf-serializer/**'

  # JOB to extract PR metadata
  pull-request-number:
    runs-on: ubuntu-latest
    outputs:
      number: ${{ steps.pull_request.outputs.number }}

    steps:
      - name: Extract number of pull request
        id: pull_request
        run: |
          echo ::set-output name=number::$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")

      - name: Prints number of pull request
        run: echo Pull request branch is '${{ steps.pull_request.outputs.number }}'

  dockerize-app-0-base-model:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-base-model == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-base-model'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-base-model:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-base-model:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-base-model-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-base-model' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions


  dockerize-app-0-field-changes:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-field-changes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-field-changes'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-field-changes:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-field-changes:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-field-change-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-field-changes' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-0-nodes:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-nodes == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-nodes'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-nodes:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-nodes:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-nodes-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-nodes' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions


  dockerize-app-0-statement-subject:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-statement-subject == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-statement-subject'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-statement-subject:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-statement-subject:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-statement-subject-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-statement-subject' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-0-statement-object:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-statement-object == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-statement-object'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-statement-object:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-statement-object:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-statement-object-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-statement-object' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-1-base-config:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-1-base-config == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-1-base-config'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-1-base-config:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-1-base-config:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-base-config-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-1-base-config' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-2-entity-label:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-2-entity-label == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-2-entity-label'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-2-entity-label:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-2-entity-label:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-entity-label-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-2-entity-label' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions


  dockerize-app-0-analysis-statements:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-0-analysis-statements == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-0-analysis-statements'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-0-analysis-statements:printDockerTagSuffix)

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Create and push docker image
      - name: Create docker and push image
        run: |
          ./gradlew app-0-analysis-statements:build \
            -Dquarkus.package.type=native \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.registry="ghcr.io" \
            -Dquarkus.container-image.group="geovistory" \
            -Dquarkus.container-image.name="toolbox-streams-analysis-statements-quarkus" \
            -Dquarkus.container-image.tag="${{steps.extract_docker_tag_suffix.outputs.value}}"


      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-0-analysis-statements' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions


  dockerize-app-3-entity:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-3-entity == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-3-entity'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
        with:
          arguments: app-3-entity:build # "app-3-entity:" points to /app-3-entity

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # Create docker image
      - name: Create docker image
        run: ./gradlew app-3-entity:jibDockerBuild

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # push docker image
      - name: Push docker image
        run: docker push $(./gradlew -q app-3-entity:printDockerImageTag)

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-3-entity:printDockerTagSuffix)

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-3-entity' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-3-fulltext:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-3-fulltext == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-3-fulltext'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
        with:
          arguments: app-3-fulltext:build # "app-3-fulltext:" points to /app-3-fulltext

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # Create docker image
      - name: Create docker image
        run: ./gradlew app-3-fulltext:jibDockerBuild

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # push docker image
      - name: Push docker image
        run: docker push $(./gradlew -q app-3-fulltext:printDockerImageTag)

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-3-fulltext:printDockerTagSuffix)

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-3-fulltext' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-4-entity-preview:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-4-entity-preview == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-4-entity-preview'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
        with:
          arguments: app-4-entity-preview:build # "app-4-entity-preview:" points to /app-4-entity-preview

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # Create docker image
      - name: Create docker image
        run: ./gradlew app-4-entity-preview:jibDockerBuild

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # push docker image
      - name: Push docker image
        run: docker push $(./gradlew -q app-4-entity-preview:printDockerImageTag)

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-4-entity-preview:printDockerTagSuffix)

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-4-entity-preview' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  dockerize-app-5-rdf-serializer:
    needs: [ detect-changes, pull-request-number ]
    if: ${{ needs.detect-changes.outputs.app-5-rdf-serializer == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Test and Dockerize 'app-5-rdf-serializer'"
          description: "PR: ${{ needs.pull-request-number.outputs.number }}"
          color: 0xffed2b
          username: GitHub Actions

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Git Identity
        run: |
          git config --global user.name 'geovbot'
          git config --global user.email 'github.bot@geovistory.org'
          git remote set-url origin https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      # This step will build a Java project with Gradle and cache/restore any dependencies  to improve
      # the workflow execution time. For more information see:
      # https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle
      - name: Build with Gradle
        uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
        with:
          arguments: app-5-rdf-serializer:build # "app-3-rdf-serializer:" points to /app-5-rdf-serializer

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # Create docker image
      - name: Create docker image
        run: ./gradlew app-5-rdf-serializer:jibDockerBuild

      # login to ghcr.io
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # push docker image
      - name: Push docker image
        run: docker push $(./gradlew -q app-5-rdf-serializer:printDockerImageTag)

      # extract tag (e.g. 1.0.1-pr-32.0)
      - name: Extract docker tag suffix
        id: extract_docker_tag_suffix
        run: |
          echo ::set-output name=value::$(./gradlew -q app-5-rdf-serializer:printDockerTagSuffix)

      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_GITHUB_CHANNEL_WEBHOOK }}
          title: "Dockerize 'app-5-rdf-serializer' > Done"
          description: "Image Tag: ${{steps.extract_docker_tag_suffix.outputs.value}}"
          color: 0x0000ff
          username: GitHub Actions

  # JOB to update the metadata about the PR
  update-pull-request-metadata:

    # about needs and if see: https://stackoverflow.com/a/66358138/11786845
    needs: [
      pull-request-number,
      dockerize-app-0-base-model,
      dockerize-app-0-field-changes,
      dockerize-app-0-nodes,
      dockerize-app-0-statement-subject,
      dockerize-app-0-statement-object,
      dockerize-app-1-base-config,
      dockerize-app-2-entity-label,
      dockerize-app-3-analysis-statements,
      dockerize-app-3-entity,
      dockerize-app-3-fulltext,
      dockerize-app-4-entity-preview,
      dockerize-app-5-rdf-serializer,
    ]
    # contains(needs.*.result, 'success') will be true if at least one of the jobs succeeded.
    # !(contains(needs.*.result, 'failure')) is false if any job failed
    if: |
      always()
      && contains(needs.*.result, 'success')
      && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      # this will update metadata about PR for the docker tag in /build.gradle
      - name: Update pull request metadata in build.gradle
        id: version
        run: bash updatePRMetadata.bash ${{ needs.pull-request-number.outputs.number }}

      # commit the PR metadata updates
      - uses: EndBug/add-and-commit@v5
        with:
          message: 'chore(): update pr metadata'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
