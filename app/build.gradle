/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'org.geovistory.toolbox.streams.java-application-conventions'

    // Used to containerize the project
    id 'com.google.cloud.tools.jib' version '3.3.0'
}


dependencies {

    implementation 'org.apache.commons:commons-text'
    // utilities project
    implementation project(':utilities')
    // lib
    implementation project(':lib')
    // Kafka streams
    implementation 'org.apache.kafka:kafka-streams:3.3.1'
    // Apicurio Avro Serdes
    implementation group: 'io.apicurio', name: 'apicurio-registry-serdes-avro-serde', version: '2.3.1.Final'
}

application {
    // Define the main class for the application.
    mainClass = 'org.geovistory.toolbox.streams.app.App'
}

jar {
    manifest.attributes('Main-Class': application.mainClass)
}

jib {
    to {
        image = getDockerImageTag()
    }
    container {
        jvmFlags = []
        mainClass = application.mainClass
        format = 'OCI'
    }
}


/**
 * Get docker tag suffix from semanti version and pull request metadata.
 * @return for example "0.2.3" or "0.1.0-pr-12.0"
 */
String getDockerTagSuffix() {
    if (pullRequestNumber) return "${project.semanticVersion.version.get()}-pr-${pullRequestNumber}.${pullRequestPushCount}"
    else return "${project.semanticVersion.version.get()}"
}
/**
 * Get docker image tag
 * @return for example "ghcr.io/geovistory/toolbox-streams:0.1.0"
 */
String getDockerImageTag() {
    return 'ghcr.io/geovistory/toolbox-streams:' + getDockerTagSuffix()
}

task("printDockerImageTag") {
    doLast {
        println getDockerImageTag()
    }
}

task("printDockerTagSuffix") {
    doLast {
        println getDockerTagSuffix()
    }
}

// inspired by https://discuss.gradle.org/t/how-to-get-gradle-variables-in-my-java-method/37580/2
task generateJava {
    ext.outputDir = "$buildDir/generated/java"
    outputs.dir outputDir
    doLast {
        mkdir "$outputDir/org/geovistory/toolbox/streams/app"
        file("$outputDir/org/geovistory/toolbox/streams/app/BuildProperties.java").text =
                """|package org.geovistory.toolbox.streams.app;
               |public class BuildProperties {
               |    public static String getDockerTagSuffix() { return "${getDockerTagSuffix()}"; }
               |}""".stripMargin()
    }
}
compileJava.dependsOn generateJava
sourceSets.main.java.srcDir generateJava.outputDir